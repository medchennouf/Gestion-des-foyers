pipeline {
    agent any

    environment {
        PATH = "/usr/local/bin:/usr/bin:/bin:${env.PATH}"
    }

    stages {

        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Build') {
            steps {
                echo 'Building project...'
            }
        }

        stage('Unit Tests') {
            steps {
                echo 'Running tests...'
                sh 'pytest --maxfail=1 --disable-warnings -q'
            }
        }

        stage('Security Scan - Bandit') {
            steps {
                echo 'Running Bandit scan...'
                sh 'python3 -m pip install --upgrade bandit'
                sh '/usr/local/bin/bandit -r . -f json -o bandit.json'
                sh 'head -n 20 bandit.json'
            }
        }

        stage('Check Bandit Vulnerabilities') {
            steps {
                echo 'Checking Bandit vulnerabilities...'
                sh '''
                python3 - <<EOF || true
import json
try:
    with open("bandit.json") as f:
        data = json.load(f)
    issues = []
    for file, metrics in data.get("metrics", {}).items():
        if metrics.get("SEVERITY.HIGH", 0) > 0 or metrics.get("SEVERITY.MEDIUM", 0) > 0:
            issues.append(f"{file} | MEDIUM/HIGH issue found")
    if issues:
        print("Bandit security issues found:", len(issues))
        for i in issues:
            print(i)
    else:
        print("No Bandit security issues found")
except Exception as e:
    print("Error reading bandit.json:", e)
EOF
                '''
            }
        }

        stage('Security Scan - Trivy FS') {
            steps {
                echo 'Running Trivy FS scan...'
                // sh 'trivy fs .' 
            }
        }

        stage('Security Scan - Gitleaks') {
            steps {
                echo 'Running Gitleaks scan...'
                // sh 'gitleaks detect --source=.' 
            }
        }

        stage('Docker Build') {
            steps {
                echo 'Building Docker image...'
                // sh 'docker build -t myimage:latest .' 
            }
        }

        stage('Docker Image Security - Trivy') {
            steps {
                echo 'Running Docker image security scan...'
                // sh 'trivy image myimage:latest' 
            }
        }

        stage('Final Security Check') {
            steps {
                echo 'Performing final security check...'
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: '**/*.json', allowEmptyArchive: true
            echo 'Security reports archived'
        }
    }
}
