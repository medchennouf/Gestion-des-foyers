pipeline {
  agent any

  environment {
    SONAR_HOST_URL    = 'http://192.168.50.4:9000'
    SONAR_PROJECT_KEY = 'gestion-des-foyers'
    SONAR_LOGIN       = credentials('Sonar')
    DOCKERHUB_USER    = 'mohamed284'
    DOCKERHUB_PASS    = credentials('dockerhub-credentials')
    SLACK_TOKEN       = credentials('slack-token')
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Secrets Scan - Gitleaks') {
      steps {
        sh '''
          docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest \
            detect -s /repo -f json -r gitleaks.json || true
        '''
      }
    }

    stage('Build & Unit Tests') {
      steps {
        sh 'mvn clean verify'
      }
    }

    stage('SonarQube Analysis') {
      environment {
        PATH = "${tool 'sonar-scanner'}/bin:${env.PATH}"
      }
      steps {
        sh """
          sonar-scanner \
            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_LOGIN} \
            -Dsonar.sources=src/main/java \
            -Dsonar.tests=src/test/java \
            -Dsonar.junit.reportPaths=target/surefire-reports \
            -Dsonar.java.binaries=target/classes
        """
      }
    }

    stage('OWASP Dependency Check') {
      steps {
        sh '''
          mvn org.owasp:dependency-check-maven:check \
            -Dformat=HTML -Dformat=XML
        '''
      }
    }

    stage('Docker Build') {
      steps {
        sh '''
          docker build -t ${DOCKERHUB_USER}/gestion-foyers:latest .
          docker tag ${DOCKERHUB_USER}/gestion-foyers:latest ${DOCKERHUB_USER}/gestion-foyers:${BUILD_NUMBER}
        '''
      }
    }

    stage('Trivy Image Scan') {
      steps {
        sh '''
          trivy image --severity HIGH,CRITICAL ${DOCKERHUB_USER}/gestion-foyers:latest || true
        '''
      }
    }

    stage('Push DockerHub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub-credentials',
          usernameVariable: 'USER',
          passwordVariable: 'PASS'
        )]) {
          sh '''
            echo "$PASS" | docker login -u "$USER" --password-stdin
            docker push ${DOCKERHUB_USER}/gestion-foyers:latest
            docker push ${DOCKERHUB_USER}/gestion-foyers:${BUILD_NUMBER}
            docker logout
          '''
        }
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          docker rm -f gestion-foyers-container 2>/dev/null || true
          docker run -d --name gestion-foyers-container \
            -p 8081:8080 \
            ${DOCKERHUB_USER}/gestion-foyers:latest
        '''
      }
    }

    stage('DAST - OWASP ZAP') {
      steps {
        sh '''
          docker run --rm -v $(pwd):/zap/wrk/:rw --network="host" \
            owasp/zap2docker-stable \
            zap-baseline.py -t http://127.0.0.1:8081/tpfoyer -r zap-report.html || true
        '''
      }
    }
  }

  post {
    always {
      // Tests unitaires
      junit 'target/surefire-reports/*.xml'

      // Rapports sécurité
      archiveArtifacts artifacts: 'target/dependency-check-report.xml', allowEmptyArchive: true
      archiveArtifacts artifacts: 'gitleaks.json', allowEmptyArchive: true
      archiveArtifacts artifacts: 'zap-report.html', allowEmptyArchive: true
    }
    success {
      slackSend (
        channel: '#devsecops-pipeline',
        color: 'good',
        tokenCredentialId: 'slack-token',
        message: "✅ Build #${env.BUILD_NUMBER} SUCCESS on ${env.JOB_NAME} (${env.GIT_COMMIT})"
      )
    }
    failure {
      slackSend (
        channel: '#devsecops-pipeline',
        color: 'danger',
        tokenCredentialId: 'slack-token',
        message: "❌ Build #${env.BUILD_NUMBER} FAILED on ${env.JOB_NAME} (${env.GIT_COMMIT})"
      )
    }
  }
}
