pipeline {
  agent any

  environment {
    PATH = "/usr/local/bin:/usr/bin:/bin:${env.PATH}"
    SEMGREP_API_KEY = credentials('semgrep-api-key')
  }

  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build') {
      steps { echo 'Building project...' }
    }

    stage('Unit Tests') {
      steps {
        sh '''
          pytest --maxfail=1 --disable-warnings \
            --cov=. --cov-report=xml || true
        '''
      }
    }

    stage('SonarQube Analysis') {
      environment {
        scannerHome = tool 'SonarScanner'
      }
      steps {
        withSonarQubeEnv('Sonar') {
          sh """
            ${scannerHome}/bin/sonar-scanner \
              -Dsonar.projectKey=gestion-des-foyers \
              -Dsonar.projectName=gestion-des-foyers \
              -Dsonar.sources=. \
              -Dsonar.exclusions=**/*.java \
              -Dsonar.python.coverage.reportPaths=coverage.xml
          """
        }
      }
    }

    stage('SAST - Bandit') {
      steps {
        sh '''
          python3 -m pip install --user --upgrade bandit || true
          bandit -r . -f json -o bandit.json || true
        '''
      }
    }

    stage('SAST - Semgrep') {
      environment {
        PATH = "${env.PATH}:${env.HOME}/.local/bin"
      }
      steps {
        sh '''
          python3 -m pip install --user --upgrade semgrep || true
          semgrep login --api-key $SEMGREP_API_KEY || true
          semgrep --config=p/ci --json --output semgrep.json || true
        '''
      }
    }

    stage('SCA & FS scan - Trivy') {
      steps {
        sh '''
          rm -f trivy-fs.json || true
          trivy fs --scanners vuln,misconfig,secret \
            --severity HIGH,CRITICAL \
            --format json -o trivy-fs.json . || true
        '''
      }
    }

    stage('Secrets - Gitleaks') {
      steps {
        sh '''
          gitleaks detect --source . \
            --baseline-path gitleaks-baseline.json \
            --report-format json \
            --report-path gitleaks.json || true
        '''
      }
    }

    stage('Docker Build') {
      steps {
        sh 'docker build -t gestion-foyers:latest . || true'
      }
    }

    stage('Trivy - Image scan') {
      steps {
        sh '''
          rm -f trivy-image.json || true
          trivy image --scanners vuln,misconfig,secret \
            --severity HIGH,CRITICAL \
            --format json -o trivy-image.json gestion-foyers:latest || true
        '''
      }
    }

    stage('DAST - ZAP Baseline') {
      steps {
        sh '''
          mkdir -p zap-reports
          docker run --rm \
            -v $(pwd)/zap-reports:/zap/wrk/:rw \
            ghcr.io/zaproxy/zaproxy:latest zap-baseline.py \
              -t "http://192.168.50.4:8080" \
              -r baseline_report.html \
              -J baseline_report.json || true
        '''
      }
    }

    stage('Final security check') {
      steps {
        sh '''
          python3 - <<'PY'
import json, os, sys
fail = False

# Bandit (log-only)
if os.path.exists("bandit.json"):
  try:
    b = json.load(open("bandit.json"))
    vuln = [r for r in b.get("results", []) if r.get("issue_severity") in ("MEDIUM", "HIGH")]
    if vuln:
      print("Bandit MEDIUM/HIGH (not blocking for this demo):", len(vuln))
  except Exception as e:
    print("Error reading bandit.json:", e)

# Semgrep (log-only)
if os.path.exists("semgrep.json"):
  try:
    s = json.load(open("semgrep.json"))
    if s.get("results"):
      print("Semgrep findings (not blocking for this demo):", len(s.get("results")))
  except Exception as e:
    print("Error reading semgrep.json:", e)

# Trivy FS (log-only)
if os.path.exists("trivy-fs.json"):
  try:
    t = json.load(open("trivy-fs.json"))
    has = [r for r in t.get("Results", []) if r.get("Vulnerabilities") or r.get("Misconfigurations") or r.get("Secrets")]
    if has:
      print("Trivy FS issues (not blocking for this demo):", len(has))
  except Exception as e:
    print("Error reading trivy-fs.json:", e)

# Trivy Image (log-only)
if os.path.exists("trivy-image.json"):
  try:
    ti = json.load(open("trivy-image.json"))
    hasimg = [r for r in ti.get("Results", []) if r.get("Vulnerabilities") or r.get("Misconfigurations") or r.get("Secrets")]
    if hasimg:
      print("Trivy image issues (not blocking for this demo):", len(hasimg))
  except Exception as e:
    print("Error reading trivy-image.json:", e)

# Gitleaks (bloquant)
if os.path.exists("gitleaks.json"):
  try:
    g = json.load(open("gitleaks.json"))
    if g:
      print("Gitleaks secrets found:", len(g))
      fail = True
  except Exception as e:
    print("Error reading gitleaks.json:", e)

# ZAP baseline (bloquant)
if os.path.exists("zap-reports/baseline_report.json"):
  try:
    z = json.load(open("zap-reports/baseline_report.json"))
    fails = z.get("fail", 0) if isinstance(z, dict) else 0
    if fails:
      print("ZAP baseline fail:", fails)
      fail = True
  except Exception as e:
    print("Unable to parse ZAP baseline_report.json:", e)

if fail:
  print("Security gates failed")
  sys.exit(1)
else:
  print("All clear")
PY
        '''
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          docker rm -f gestion-foyers-container 2>/dev/null || true
          docker run -d --name gestion-foyers-container \
            -p 5001:8080 \
            gestion-foyers:latest
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '**/*.json', allowEmptyArchive: true
      archiveArtifacts artifacts: 'zap-reports/*', allowEmptyArchive: true
      publishHTML([
        reportDir: 'zap-reports',
        reportFiles: 'baseline_report.html',
        reportName: 'OWASP ZAP Report',
        allowMissing: true,
        keepAll: true,
        alwaysLinkToLastBuild: true
      ])
    }
    success {
      slackSend(
        channel: '#devsecops-pipeline',
        color: 'good',
        message: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${env.BUILD_URL}"
      )
    }
    failure {
      slackSend(
        channel: '#devsecops-pipeline',
        color: 'danger',
        message: "FAILURE: ${env.JOB_NAME} #${env.BUILD_NUMBER} - ${env.BUILD_URL}"
      )
    }
  }
}
